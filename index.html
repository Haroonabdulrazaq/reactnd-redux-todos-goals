<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Udacity Todo Goals</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js'></script>
  <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
</head>
<body>
  <div>
    <h2>Todo List</h2>
    <input type="text" id="todo" placeholder="Add Todo">
    <button id="todoBtn">Add Todo</button>
    <ul id="todos"></ul>
  </div>
  <div>
    <h2>Goals</h2>
    <input type="text" id="goal"  placeholder="Add Goal">
    <button id="goalBtn">Add Goal</button>
    <ul id="goals"></ul>
  </div>
  <hr/>
  <div id="app"></div>

  
  <script type="text/javaScript">
    const ADD_TODO = "ADD_TODO";
    const REMOVE_TODO = "REMOVE_TODO";
    const TOGGLE_TODO= "TOGGLE_TODO";
    const ADD_GOAL= "ADD_GOAL";
    const REMOVE_GOAL = "REMOVE_GOAL";

// Action Creators
  const addTodoAction = (todo)=>{
    return {
     type: ADD_TODO,
      todo
    }
  }
  const removeTodoAction = (id)=>{
    return {
     type: REMOVE_TODO,
      id
    }
  }
  const toggleTodoAction = (id)=>{
    return {
     type: TOGGLE_TODO,
      id
    }
  }
  const addGoalAction = (goal)=>{
    return {
     type: ADD_GOAL,
      goal
    }
  }
  const removeGoalAction = (id)=>{
    return {
     type: REMOVE_GOAL,
      id
    }
  }



// App Code

function todos(state=[], action){
  switch (action.type) {
    case ADD_TODO:
      return state.concat([action.todo])
    case REMOVE_TODO:
      const newTodos = state.filter(todo => todo.id !== action.id)
      return newTodos
    case TOGGLE_TODO:
      return state.map(todo => todo.id !== action.id? todo : 
        Object.assign({}, todo, { completed: !todo.completed }));
    default:
      return state;
  }
}
  // Goal Reducer

  const goals =(state=[], action)=>{
    switch (action.type) {
      case ADD_GOAL:
        return state.concat([action.goal])
      case REMOVE_GOAL:
        return state.filter((goal) => goal.id !== action.id)
    
      default:
        return state;
    }
  }

  //Generate Id dynamically
    const generateId= ()=> {
      return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
    }

    const checker =(store)=> (next)=> (action) =>{
      if( action.type === ADD_TODO && action.todo.name.toLowerCase().includes('bitcoin')){
        alert("I include bitcoin") 
        return
      }

      if( action.type === ADD_GOAL && action.goal.name.toLowerCase().includes('bitcoin')){
        alert("This is a Bad Idea")
        return 
      }

      return next(action)
    } 

    const logger =(store) => (next) => (action) => {
        console.group(action.type);
          console.log("This is the action: ", action);
          const result = next(action);
          console.log("The new State: ", store.getState())
        console.groupEnd();
        return result;
    }

    // const middlewares =[checker, logger]
      const rootReducer = Redux.combineReducers({todos,goals})

  const store = Redux.createStore(rootReducer, Redux.applyMiddleware(checker, logger));

  store.subscribe(()=>{
   const {todos, goals} = store.getState();

   document.getElementById("todos").innerHTML= ""
   document.getElementById("goals").innerHTML= ""

   todos.forEach(addTodoToDOM)
   goals.forEach(addGoalToDOM)
  })

  const addTodo =()=>{

    const input = document.getElementById('todo');
    const inputValue = input.value;
    input.value = "";

    store.dispatch( addTodoAction({
      id: generateId(),
      name: inputValue,
      completed: false,
    }))
  }

  const addGoal =()=>{
    const input = document.getElementById('goal');
    const inputValue = input.value;
    input.value = "";

    store.dispatch( addGoalAction({
      id: generateId(),
      name: inputValue,
    }))
  }

    document.getElementById('todoBtn')
      .addEventListener('click', addTodo)

    document.getElementById('goalBtn')
      .addEventListener('click', addGoal)

    const createRemoveButton =(onClick)=>{
      const removeBtn = document.createElement('button');
      removeBtn.innerHTML = 'X';
      
      removeBtn.addEventListener('click', onClick);

      return removeBtn
    }
  
  const addTodoToDOM =(todo) => {
    const node = document.createElement("li");
    const text = document.createTextNode(todo.name);

    const removeBtn = createRemoveButton(()=>
      store.dispatch(removeTodoAction(todo.id))
    )
    node.appendChild(text);
    node.appendChild(removeBtn);
    node.style.textDecoration = todo.completed? "line-through" : "none";
    node.addEventListener("click", ()=>{
      console.log("In eventListener", todo.id);
      store.dispatch(toggleTodoAction(todo.id))
    })

    document.getElementById('todos')
      .appendChild(node);
  }

  const addGoalToDOM =(goal) => {
    const node = document.createElement("li");
    const text = document.createTextNode(goal.name);
    
    const removeBtn = createRemoveButton(()=>
      store.dispatch(removeGoalAction(goal.id))
    )
    node.appendChild(text);
    node.appendChild(removeBtn);
    document.getElementById('goals')
      .appendChild(node)
  }

  </script>
  <script type="text/babel">
    class List extends React.Component {
      render(){
        return(
          <ul>
            <li>LIST</li> 
          </ul>
        )
      }
    }
    class Todos extends React.Component {
      addItem=(e)=>{
        e.preventDefault();
        const name = this.input.value;
        this.input.value =''

        this.props.store.dispatch(addTodoAction({
          name,
          complete: false,
          id: generateId()
        }))
      }
      render(){
        return(
          <div>
            <h2>Todos</h2>
            <input type="text" placeholder="Add Todo" ref={(input)=> this.input = input} />
            <button onClick={this.addItem}>Add todo</button>
            <div><List /></div> 
          </div>
        )
      }
    }
    class Goals extends React.Component {
      render(){
        return(
          <div>
            <h2>Goals</h2>
            <div><List /></div> 
          </div>
        )
      }
    }
    class App extends React.Component {
      render() {
        return(
          <div>
            <Todos store={this.props.store} />  
            <Goals store={this.props.store} />  
          </div>
        );
      }
    }

    ReactDOM.render(
      <App store={store}/>, document.getElementById('app')
    )
  </script>
</body> 
</html>